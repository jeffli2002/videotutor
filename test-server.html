<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathTutor AI - æœåŠ¡å™¨ç‰ˆæµ‹è¯•ç¯å¢ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">ğŸ¬ MathTutor AI æµ‹è¯•ç¯å¢ƒ</h1>
            <p class="text-xl text-gray-600">K12æ•°å­¦AIè§†é¢‘ç”Ÿæˆå¹³å° - æœåŠ¡å™¨ç‰ˆ</p>
            <div class="mt-2 text-sm text-green-600">
                âœ… å·²è§£å†³CORSè·¨åŸŸé—®é¢˜ | ğŸš€ æœ¬åœ°æœåŠ¡å™¨è¿è¡Œ
            </div>
        </div>

        <!-- API Status -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.349 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.349a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.349 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.349a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                APIé…ç½®çŠ¶æ€
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex items-center justify-between p-3 border rounded-lg">
                    <div>
                        <div class="font-medium">é€šä¹‰åƒé—® API</div>
                        <div class="text-sm text-gray-600" id="api-status-text">æœªæ£€æµ‹</div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-medium" id="api-status-badge">
                        ğŸ”„ æ£€æµ‹ä¸­
                    </span>
                </div>
                <div class="flex items-center justify-between p-3 border rounded-lg">
                    <div>
                        <div class="font-medium">æœ¬åœ°æœåŠ¡å™¨</div>
                        <div class="text-sm text-gray-600">ä»£ç†æœåŠ¡è¿è¡Œä¸­</div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        âœ… è¿è¡Œä¸­
                    </span>
                </div>
            </div>
        </div>

        <!-- API Key Input -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">ğŸ”‘ APIå¯†é’¥é…ç½®</h2>
            <div class="flex flex-col gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        é€šä¹‰åƒé—®APIå¯†é’¥ (ä»¥sk-å¼€å¤´)
                    </label>
                    <input
                        type="password"
                        id="api-key"
                        placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        value=""
                    >
                </div>
                <div class="flex gap-2">
                    <button
                        onclick="testApiConnection()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500"
                    >
                        æµ‹è¯•è¿æ¥
                    </button>
                    <button
                        onclick="clearApiKey()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 focus:ring-2 focus:ring-gray-500"
                    >
                        æ¸…é™¤
                    </button>
                </div>
            </div>
        </div>

        <!-- Language Selection -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">ğŸŒ è¯­è¨€é€‰æ‹©</h2>
            <div class="flex flex-wrap gap-3">
                <button
                    onclick="setLanguage('zh')"
                    class="px-4 py-2 rounded-lg border-2 transition-colors"
                    id="lang-zh"
                >
                    ğŸ‡¨ğŸ‡³ ä¸­æ–‡
                </button>
                <button
                    onclick="setLanguage('en')"
                    class="px-4 py-2 rounded-lg border-2 transition-colors"
                    id="lang-en"
                >
                    ğŸ‡ºğŸ‡¸ English
                </button>
            </div>
        </div>

        <!-- Example Questions -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">ğŸ“š ç¤ºä¾‹é—®é¢˜</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="example-questions">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Question Input -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">âœï¸ è¾“å…¥æ•°å­¦é—®é¢˜</h2>
            <div class="space-y-4">
                <textarea
                    id="math-question"
                    placeholder="è¾“å…¥æ‚¨çš„æ•°å­¦é—®é¢˜ï¼Œä¾‹å¦‚ï¼šè§£æ–¹ç¨‹ 2x + 5 = 15"
                    class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                    rows="4"
                ></textarea>
                <div class="flex justify-between items-center">
                    <div class="flex space-x-2">
                        <button onclick="uploadImage()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            ä¸Šä¼ å›¾ç‰‡
                        </button>
                        <button onclick="voiceInput()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                            è¯­éŸ³è¾“å…¥
                        </button>
                        <button onclick="clearQuestion()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            æ¸…é™¤
                        </button>
                    </div>
                    <button
                        onclick="generateVideo()"
                        id="generate-btn"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 flex items-center font-semibold"
                    >
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        ç”ŸæˆAIæ•™å­¦è§†é¢‘
                    </button>
                </div>
            </div>
        </div>

        <!-- Generation Progress -->
        <div id="progress-container" class="bg-white rounded-lg shadow-lg p-6 mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4">ğŸ”„ ç”Ÿæˆè¿›åº¦</h2>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span id="current-step">å‡†å¤‡å¼€å§‹...</span>
                    <span class="text-sm text-gray-600" id="progress-percentage">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-600" id="progress-description">æ­£åœ¨å‡†å¤‡...</p>
            </div>
        </div>

        <!-- Results -->
        <div id="results-container" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <h2 class="text-xl font-semibold mb-4 flex items-center" id="results-title">
                <!-- Will be populated by JavaScript -->
            </h2>
            <div id="results-content">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentLanguage = 'zh';
        let isGenerating = false;
        let apiKey = '';
        
        // Example questions
        const exampleQuestions = {
            zh: [
                "è§£æ–¹ç¨‹ï¼š2x + 5 = 15",
                "æ±‚åº•è¾¹ä¸º8ï¼Œé«˜ä¸º6çš„ä¸‰è§’å½¢é¢ç§¯",
                "åŒ–ç®€ï¼š(3x + 2)(x - 4)",
                "ä»€ä¹ˆæ˜¯ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹ï¼Ÿ",
                "è§£ä¸ç­‰å¼ï¼š3x - 7 > 14"
            ],
            en: [
                "Solve for x: 2x + 5 = 15",
                "Find the area of a triangle with base 8 and height 6",
                "Simplify: (3x + 2)(x - 4)",
                "What is a linear equation?",
                "Solve the inequality: 3x - 7 > 14"
            ]
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setLanguage('zh');
            updateApiKeyStatus();
        });

        // Language functions
        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('lang-zh').className = lang === 'zh' ? 
                'px-4 py-2 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700' : 
                'px-4 py-2 rounded-lg border-2 border-gray-300 text-gray-700 hover:border-gray-400';
            document.getElementById('lang-en').className = lang === 'en' ? 
                'px-4 py-2 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700' : 
                'px-4 py-2 rounded-lg border-2 border-gray-300 text-gray-700 hover:border-gray-400';
            
            updateExampleQuestions();
        }

        function updateExampleQuestions() {
            const container = document.getElementById('example-questions');
            container.innerHTML = '';
            
            exampleQuestions[currentLanguage].forEach(question => {
                const button = document.createElement('button');
                button.className = 'text-left p-3 border border-gray-300 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-colors';
                button.textContent = question;
                button.onclick = () => selectExampleQuestion(question);
                container.appendChild(button);
            });
        }

        function selectExampleQuestion(question) {
            document.getElementById('math-question').value = question;
        }

        // API functions
        function updateApiKeyStatus() {
            const apiKeyInput = document.getElementById('api-key');
            const statusText = document.getElementById('api-status-text');
            const statusBadge = document.getElementById('api-status-badge');
            
            apiKey = apiKeyInput.value.trim();
            
            if (apiKey) {
                statusText.textContent = `å·²é…ç½® (${apiKey.substring(0, 8)}...)`;
                statusBadge.textContent = 'âœ… å·²é…ç½®';
                statusBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
            } else {
                statusText.textContent = 'æœªé…ç½®';
                statusBadge.textContent = 'âŒ æœªé…ç½®';
                statusBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
            }
        }

        function clearApiKey() {
            document.getElementById('api-key').value = '';
            updateApiKeyStatus();
        }

        function clearQuestion() {
            document.getElementById('math-question').value = '';
            
            // å¦‚æœæœ‰æ˜¾ç¤ºç»“æœï¼Œä¹Ÿæ¸…é™¤ç»“æœ
            const resultsContainer = document.getElementById('results-container');
            if (resultsContainer && !resultsContainer.classList.contains('hidden')) {
                resultsContainer.classList.add('hidden');
            }
            
            // å¦‚æœæœ‰è¿›åº¦æ˜¾ç¤ºï¼Œä¹Ÿæ¸…é™¤è¿›åº¦
            const progressContainer = document.getElementById('progress-container');
            if (progressContainer && !progressContainer.classList.contains('hidden')) {
                progressContainer.classList.add('hidden');
            }
        }

        async function testApiConnection() {
            const apiKeyInput = document.getElementById('api-key');
            const testKey = apiKeyInput.value.trim();
            
            if (!testKey) {
                alert('è¯·å…ˆè¾“å…¥APIå¯†é’¥');
                return;
            }
            
            const statusText = document.getElementById('api-status-text');
            const statusBadge = document.getElementById('api-status-badge');
            
            statusText.textContent = 'æµ‹è¯•ä¸­...';
            statusBadge.textContent = 'ğŸ”„ æµ‹è¯•ä¸­';
            statusBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
            
            console.log('å¼€å§‹APIè¿æ¥æµ‹è¯•...', { testKey: testKey.substring(0, 8) + '...' });
            
            try {
                const requestData = {
                    api_key: testKey,
                    messages: [{
                        role: 'user',
                        content: 'ä½ å¥½ï¼Œè¯·ç®€å•ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚'
                    }],
                    temperature: 0.1,
                    max_tokens: 100
                };
                
                console.log('å‘é€è¯·æ±‚æ•°æ®:', requestData);
                
                const response = await fetch('http://localhost:8000/api/qwen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('æ”¶åˆ°å“åº”:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log('å“åº”æ–‡æœ¬:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSONè§£æå¤±è´¥:', parseError);
                    throw new Error(`æ— æ³•è§£ææœåŠ¡å™¨å“åº”: ${parseError.message}`);
                }
                
                console.log('è§£æåçš„æ•°æ®:', data);
                
                if (data.output && data.output.text) {
                    apiKey = testKey;
                    statusText.textContent = `è¿æ¥æˆåŠŸ (${testKey.substring(0, 8)}...)`;
                    statusBadge.textContent = 'âœ… è¿æ¥æˆåŠŸ';
                    statusBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    alert('APIè¿æ¥æµ‹è¯•æˆåŠŸï¼\n\n' + data.output.text);
                } else {
                    throw new Error(data.error || data.message || 'æœåŠ¡å™¨è¿”å›äº†æ„å¤–çš„å“åº”æ ¼å¼');
                }
            } catch (error) {
                console.error('APIæµ‹è¯•å¤±è´¥:', error);
                statusText.textContent = 'è¿æ¥å¤±è´¥';
                statusBadge.textContent = 'âŒ è¿æ¥å¤±è´¥';
                statusBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
                
                let errorMessage = error.message;
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'æ— æ³•è¿æ¥åˆ°æœ¬åœ°æœåŠ¡å™¨ï¼Œè¯·ç¡®è®¤:\n1. æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ\n2. åœ°å€æ˜¯å¦æ­£ç¡®: http://localhost:8000\n3. é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº†è¿æ¥';
                }
                
                alert('APIè¿æ¥æµ‹è¯•å¤±è´¥ï¼š\n' + errorMessage);
            }
        }

        // Video generation functions
        async function generateVideo() {
            const question = document.getElementById('math-question').value.trim();
            
            if (!question) {
                alert('è¯·è¾“å…¥æ•°å­¦é—®é¢˜');
                return;
            }
            
            // ä»è¾“å…¥æ¡†è·å–APIå¯†é’¥
            apiKey = document.getElementById('api-key').value.trim();
            
            if (!apiKey) {
                alert('è¯·å…ˆè¾“å…¥é€šä¹‰åƒé—®APIå¯†é’¥');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                alert('APIå¯†é’¥æ ¼å¼é”™è¯¯ï¼Œåº”è¯¥ä»¥sk-å¼€å¤´');
                return;
            }
            
            if (isGenerating) {
                return;
            }
            
            isGenerating = true;
            document.getElementById('generate-btn').disabled = true;
            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('results-container').classList.add('hidden');
            
            try {
                // Step 1: Analyze question
                await updateProgress(10, 'ğŸ” åˆ†ææ•°å­¦é—®é¢˜...', 'æ­£åœ¨åˆ†ææ‚¨çš„æ•°å­¦é—®é¢˜...');
                await delay(1000);
                
                // Step 2: Call Qwen API
                await updateProgress(25, 'ğŸ¤– AIè§£é¢˜åˆ†æä¸­...', 'æ­£åœ¨è°ƒç”¨é€šä¹‰åƒé—®APIè§£é¢˜...');
                const mathSolution = await callQwenAPI(question);
                
                if (!mathSolution.success) {
                    throw new Error(mathSolution.error || 'AIè§£é¢˜å¤±è´¥');
                }
                
                // Step 3: Generate script
                await updateProgress(40, 'ğŸ“ ç”Ÿæˆæ•™å­¦è„šæœ¬...', 'æ­£åœ¨ç”Ÿæˆæ•™å­¦è„šæœ¬...');
                await delay(1500);
                
                // Step 4: Create animation
                await updateProgress(60, 'ğŸ¬ åˆ›å»ºæ•°å­¦åŠ¨ç”»...', 'æ­£åœ¨åˆ›å»ºæ•°å­¦åŠ¨ç”»...');
                await delay(2000);
                
                // Step 5: Generate speech
                await updateProgress(80, 'ğŸ¤ åˆæˆå¤šè¯­è¨€è¯­éŸ³...', 'æ­£åœ¨åˆæˆè¯­éŸ³...');
                await delay(1500);
                
                // Step 6: Render video
                await updateProgress(95, 'ğŸ¥ æ¸²æŸ“æœ€ç»ˆè§†é¢‘...', 'æ­£åœ¨æ¸²æŸ“æœ€ç»ˆè§†é¢‘...');
                await delay(2000);
                
                // Complete
                await updateProgress(100, 'âœ… å®Œæˆ!', 'è§†é¢‘ç”Ÿæˆå®Œæˆï¼');
                await delay(500);
                
                // Show results
                showResults(mathSolution, question);
                
            } catch (error) {
                console.error('è§†é¢‘ç”Ÿæˆå¤±è´¥:', error);
                showError(error.message);
            } finally {
                isGenerating = false;
                document.getElementById('generate-btn').disabled = false;
                document.getElementById('progress-container').classList.add('hidden');
            }
        }

        async function callQwenAPI(question) {
            const prompt = buildMathPrompt(question);
            
            try {
                const requestData = {
                    api_key: apiKey,
                    messages: [
                        {
                            role: 'system',
                            content: currentLanguage === 'zh' ? 
                                'ä½ æ˜¯ä¸“ä¸šçš„K12æ•°å­¦è€å¸ˆï¼Œè¯·ç”¨æ¸…æ™°çš„ä¸­æ–‡è§£é‡Šæ•°å­¦æ¦‚å¿µå’Œè§£é¢˜æ­¥éª¤ã€‚' :
                                'You are a professional K12 math teacher. Please explain math concepts and solution steps clearly in English.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: 0.1,
                    max_tokens: 1000,
                    top_p: 0.8
                };
                
                const response = await fetch('http://localhost:8000/api/qwen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`æ— æ³•è§£ææœåŠ¡å™¨å“åº”: ${parseError.message}`);
                }
                
                if (data.output && data.output.text) {
                    return {
                        success: true,
                        data: {
                            content: data.output.text,
                            usage: data.usage,
                            model: 'qwen-plus',
                            requestId: data.request_id
                        }
                    };
                } else {
                    return {
                        success: false,
                        error: data.error || data.message || 'æœåŠ¡å™¨è¿”å›äº†æ„å¤–çš„å“åº”æ ¼å¼'
                    };
                }
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        function buildMathPrompt(question) {
            if (currentLanguage === 'zh') {
                return `è¯·è¯¦ç»†è§£ç­”è¿™ä¸ªK12æ•°å­¦é—®é¢˜ï¼š

é¢˜ç›®ï¼š${question}

è¯·æŒ‰ä»¥ä¸‹ç»“æ„å›ç­”ï¼š
1. é—®é¢˜åˆ†æ
2. è¯¦ç»†è§£é¢˜æ­¥éª¤ï¼ˆæ¯æ­¥éƒ½è¦è§£é‡ŠåŸç†ï¼‰
3. æœ€ç»ˆç­”æ¡ˆ
4. éªŒè¯è¿‡ç¨‹
5. ç›¸å…³æ•°å­¦æ¦‚å¿µ
6. å¸¸è§é”™è¯¯æé†’

è¯·ç¡®ä¿è§£é‡Šæ¸…æ™°ï¼Œé€‚åˆK12å­¦ç”Ÿç†è§£ã€‚`;
            } else {
                return `Please solve this K12 math problem in detail:

Question: ${question}

Please structure your answer as follows:
1. Problem analysis
2. Detailed solution steps (explain the reasoning for each step)
3. Final answer
4. Verification process
5. Related math concepts
6. Common mistakes to avoid

Please ensure explanations are clear and suitable for K12 students.`;
            }
        }

        async function updateProgress(percentage, step, description) {
            document.getElementById('progress-percentage').textContent = percentage + '%';
            document.getElementById('current-step').textContent = step;
            document.getElementById('progress-description').textContent = description;
            document.getElementById('progress-bar').style.width = percentage + '%';
        }

        function showResults(mathSolution, question) {
            const container = document.getElementById('results-container');
            const title = document.getElementById('results-title');
            const content = document.getElementById('results-content');
            
            title.innerHTML = `
                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                ğŸ‰ è§†é¢‘ç”ŸæˆæˆåŠŸï¼
            `;
            
            const totalTokens = mathSolution.data.usage?.total_tokens || 0;
            const costCny = totalTokens * 0.004 / 1000;
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- AIè§£é¢˜ç»“æœ -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h4 class="font-semibold text-green-800 mb-2">ğŸ¤– AIè§£é¢˜ç»“æœ</h4>
                        <div class="text-sm text-green-700 whitespace-pre-wrap">
                            ${mathSolution.data.content}
                        </div>
                        <div class="mt-3 text-xs text-green-600">
                            Tokenä½¿ç”¨: ${totalTokens} | æˆæœ¬: Â¥${costCny.toFixed(4)}
                        </div>
                    </div>
                    
                    <!-- è§†é¢‘é¢„è§ˆ -->
                    <div class="bg-gray-100 rounded-lg p-8 text-center" id="video-preview">
                        <svg class="w-16 h-16 text-blue-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-gray-600 mb-2">è§†é¢‘æ—¶é•¿: 3:00</p>
                        <button onclick="playMathVideo()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            â–¶ï¸ æ’­æ”¾è§†é¢‘
                        </button>
                    </div>
                    
                    <!-- è¯¦ç»†ä¿¡æ¯ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-medium text-blue-800 mb-2">ğŸ“Š æŠ€æœ¯ä¿¡æ¯</h4>
                            <div class="text-sm space-y-1">
                                <div>è¯­è¨€: ${currentLanguage === 'zh' ? 'ä¸­æ–‡' : 'English'}</div>
                                <div>éš¾åº¦: ä¸­çº§</div>
                                <div>æ•°å­¦ä¸»é¢˜: ä»£æ•°</div>
                                <div>å¤„ç†æ—¶é—´: 45ç§’</div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 rounded-lg p-4">
                            <h4 class="font-medium text-green-800 mb-2">ğŸ’° æˆæœ¬ä¿¡æ¯</h4>
                            <div class="text-sm space-y-1">
                                <div>å®é™…æˆæœ¬: Â¥${costCny.toFixed(4)}</div>
                                <div>ç›¸æ¯”äººå·¥è®²å¸ˆ: èŠ‚çœ98%+</div>
                                <div>ç›¸æ¯”ä¸“ä¸šåˆ¶ä½œ: èŠ‚çœ99%+</div>
                                <div>è´¨é‡: ä¸“ä¸šçº§AIæ•™å­¦</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex flex-wrap gap-4">
                        <button onclick="downloadVideo()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            ğŸ“¥ ä¸‹è½½è§†é¢‘
                        </button>
                        <button onclick="shareVideo()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            ğŸ”— åˆ†äº«é“¾æ¥
                        </button>
                        <button onclick="generateSubtitles()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            ğŸ“„ ç”Ÿæˆå­—å¹•
                        </button>
                        <button onclick="resetForm()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            ğŸ”„ é‡æ–°ç”Ÿæˆ
                        </button>
                    </div>
                </div>
            `;
            
            container.classList.remove('hidden');
        }

        function showError(errorMessage) {
            const container = document.getElementById('results-container');
            const title = document.getElementById('results-title');
            const content = document.getElementById('results-content');
            
            title.innerHTML = `
                <svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                âŒ ç”Ÿæˆå¤±è´¥
            `;
            
            content.innerHTML = `
                <div class="text-center text-red-600">
                    <p class="mb-4">${errorMessage}</p>
                    <button onclick="resetForm()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        ğŸ”„ é‡è¯•
                    </button>
                </div>
            `;
            
            container.classList.remove('hidden');
        }

        function resetForm() {
            document.getElementById('results-container').classList.add('hidden');
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('math-question').value = '';
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // æ’­æ”¾æ•°å­¦è§†é¢‘çš„æ¨¡æ‹ŸåŠŸèƒ½
        let currentMathSolution = null;
        let videoPlayer = null;
        let currentStep = 0;
        let isPlaying = false;

        function playMathVideo() {
            // è·å–å½“å‰çš„æ•°å­¦è§£é¢˜å†…å®¹
            const resultsContainer = document.getElementById('results-container');
            if (!resultsContainer || resultsContainer.classList.contains('hidden')) {
                alert('è¯·å…ˆç”Ÿæˆè§†é¢‘å†…å®¹');
                return;
            }

            // åˆ›å»ºè§†é¢‘æ’­æ”¾å™¨ç•Œé¢
            createVideoPlayer();
        }

        function createVideoPlayer() {
            const videoPreview = document.getElementById('video-preview');
            
            // åˆ›å»ºè§†é¢‘æ’­æ”¾å™¨HTML
            const playerHTML = `
                <div class="bg-black rounded-lg overflow-hidden">
                    <!-- è§†é¢‘æ’­æ”¾åŒºåŸŸ -->
                    <div class="bg-gray-900 text-white p-8 min-h-[300px] flex flex-col justify-center" id="video-content">
                        <div class="text-center mb-4">
                            <h3 class="text-xl font-bold mb-2">ğŸ¬ AIæ•°å­¦æ•™å­¦è§†é¢‘</h3>
                            <p class="text-gray-300" id="current-scene">å‡†å¤‡æ’­æ”¾...</p>
                        </div>
                        <div class="text-lg text-center" id="video-text">
                            ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹è§‚çœ‹AIè§£é¢˜è¿‡ç¨‹
                        </div>
                    </div>
                    
                    <!-- æ§åˆ¶æ  -->
                    <div class="bg-gray-800 text-white p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-4">
                                <button onclick="togglePlay()" id="play-btn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                                    â–¶ï¸ æ’­æ”¾
                                </button>
                                <button onclick="resetVideo()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                                    ğŸ”„ é‡æ’­
                                </button>
                                <button onclick="closeVideoPlayer()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">
                                    âŒ å…³é—­
                                </button>
                            </div>
                            <div class="text-sm text-gray-300">
                                <span id="current-time">00:00</span> / <span id="total-time">03:00</span>
                            </div>
                        </div>
                        
                        <!-- è¿›åº¦æ¡ -->
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" id="progress-video" style="width: 0%"></div>
                        </div>
                        
                        <div class="mt-2 text-xs text-gray-400 text-center">
                            AIæ•°å­¦æ•™å­¦è§†é¢‘ - åŸºäºé€šä¹‰åƒé—®è§£é¢˜å†…å®¹ç”Ÿæˆ
                        </div>
                    </div>
                </div>
            `;
            
            videoPreview.innerHTML = playerHTML;
        }

        function togglePlay() {
            const playBtn = document.getElementById('play-btn');
            
            if (!isPlaying) {
                startVideoPlayback();
                playBtn.textContent = 'â¸ï¸ æš‚åœ';
                isPlaying = true;
            } else {
                pauseVideoPlayback();
                playBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
                isPlaying = false;
            }
        }

        function startVideoPlayback() {
            // è·å–è§£é¢˜å†…å®¹
            const mathContent = getMathSolutionContent();
            if (!mathContent) {
                alert('æ— æ³•è·å–è§£é¢˜å†…å®¹');
                return;
            }

            // ç”Ÿæˆæ•™å­¦åœºæ™¯
            const scenes = generateTeachingScenes(mathContent);
            currentStep = 0;
            
            // å¼€å§‹æ’­æ”¾åœºæ™¯
            playScene(scenes, 0);
        }

        function getMathSolutionContent() {
            // ä»é¡µé¢ä¸­æå–AIè§£é¢˜å†…å®¹
            const contentElement = document.querySelector('.text-green-700.whitespace-pre-wrap');
            return contentElement ? contentElement.textContent : null;
        }

        function generateTeachingScenes(content) {
            // åŸºäºAIè§£é¢˜å†…å®¹ç”Ÿæˆæ•™å­¦åœºæ™¯
            const lines = content.split('\n').filter(line => line.trim());
            const scenes = [];
            
            // å¼€åœº
            scenes.push({
                title: "æ¬¢è¿è§‚çœ‹AIæ•°å­¦æ•™å­¦",
                content: "ä»Šå¤©æˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªæ•°å­¦é—®é¢˜ï¼Œè®©æˆ‘ä»¬ä¸€æ­¥æ­¥åˆ†æã€‚",
                duration: 3000
            });

            // å¤„ç†è§£é¢˜æ­¥éª¤
            for (let i = 0; i < Math.min(lines.length, 8); i++) {
                const line = lines[i].trim();
                if (line && !line.startsWith('**') && line.length > 10) {
                    scenes.push({
                        title: `æ­¥éª¤ ${scenes.length}`,
                        content: line,
                        duration: 4000
                    });
                }
            }

            // ç»“å°¾
            scenes.push({
                title: "è§£é¢˜å®Œæˆ",
                content: "é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæˆ‘ä»¬æˆåŠŸè§£å†³äº†è¿™ä¸ªæ•°å­¦é—®é¢˜ã€‚å¸Œæœ›è¿™ä¸ªAIæ•™å­¦è§†é¢‘å¯¹æ‚¨æœ‰å¸®åŠ©ï¼",
                duration: 3000
            });

            return scenes;
        }

        function playScene(scenes, index) {
            if (!isPlaying || index >= scenes.length) {
                completeVideo();
                return;
            }

            const scene = scenes[index];
            const videoContent = document.getElementById('video-content');
            const sceneElement = document.getElementById('current-scene');
            const textElement = document.getElementById('video-text');
            const progressBar = document.getElementById('progress-video');
            const currentTimeElement = document.getElementById('current-time');

            // æ›´æ–°åœºæ™¯å†…å®¹
            sceneElement.textContent = scene.title;
            textElement.textContent = scene.content;
            
            // æ›´æ–°è¿›åº¦
            const progress = ((index + 1) / scenes.length) * 100;
            progressBar.style.width = progress + '%';
            
            // æ›´æ–°æ—¶é—´
            const currentSeconds = Math.floor((index * 180) / scenes.length);
            const minutes = Math.floor(currentSeconds / 60);
            const seconds = currentSeconds % 60;
            currentTimeElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // æ’­æ”¾ä¸‹ä¸€ä¸ªåœºæ™¯
            setTimeout(() => {
                if (isPlaying) {
                    playScene(scenes, index + 1);
                }
            }, scene.duration);
        }

        function pauseVideoPlayback() {
            // æš‚åœæ’­æ”¾ï¼ˆé€šè¿‡isPlayingæ ‡å¿—æ§åˆ¶ï¼‰
        }

        function resetVideo() {
            isPlaying = false;
            currentStep = 0;
            const playBtn = document.getElementById('play-btn');
            const progressBar = document.getElementById('progress-video');
            const currentTimeElement = document.getElementById('current-time');
            const sceneElement = document.getElementById('current-scene');
            const textElement = document.getElementById('video-text');

            playBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
            progressBar.style.width = '0%';
            currentTimeElement.textContent = '00:00';
            sceneElement.textContent = 'å‡†å¤‡æ’­æ”¾...';
            textElement.textContent = 'ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹è§‚çœ‹AIè§£é¢˜è¿‡ç¨‹';
        }

        function closeVideoPlayer() {
            // æ¢å¤åŸå§‹çš„è§†é¢‘é¢„è§ˆç•Œé¢
            const videoPreview = document.getElementById('video-preview');
            videoPreview.innerHTML = `
                <svg class="w-16 h-16 text-blue-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-gray-600 mb-2">è§†é¢‘æ—¶é•¿: 3:00</p>
                <button onclick="playMathVideo()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    â–¶ï¸ æ’­æ”¾è§†é¢‘
                </button>
            `;
            
            isPlaying = false;
            currentStep = 0;
        }

        function completeVideo() {
            isPlaying = false;
            const playBtn = document.getElementById('play-btn');
            const sceneElement = document.getElementById('current-scene');
            const textElement = document.getElementById('video-text');
            
            playBtn.textContent = 'ğŸ”„ é‡æ’­';
            sceneElement.textContent = 'æ’­æ”¾å®Œæˆ';
            textElement.textContent = 'æ„Ÿè°¢è§‚çœ‹ï¼è¿™ä¸ªAIæ•™å­¦è§†é¢‘åŸºäºé€šä¹‰åƒé—®çš„è§£é¢˜å†…å®¹ç”Ÿæˆã€‚';
        }

        // å…¶ä»–åŠŸèƒ½æŒ‰é’®çš„å®ç°
        function downloadVideo() {
            alert('ğŸ“¥ ä¸‹è½½åŠŸèƒ½\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šï¼š\nâ€¢ ç”ŸæˆMP4è§†é¢‘æ–‡ä»¶\nâ€¢ åŒ…å«AIè¯­éŸ³è§£è¯´\nâ€¢ åŒ…å«æ•°å­¦åŠ¨ç”»æ•ˆæœ\nâ€¢ è‡ªåŠ¨ä¸‹è½½åˆ°æœ¬åœ°\n\nå½“å‰ä¸ºæ¼”ç¤ºç‰ˆæœ¬ï¼Œæš‚ä¸æä¾›çœŸå®ä¸‹è½½ã€‚');
        }

        function shareVideo() {
            const shareUrl = `${window.location.origin}/video/share/${Math.random().toString(36).substr(2, 9)}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'AIæ•°å­¦æ•™å­¦è§†é¢‘',
                    text: 'çœ‹çœ‹è¿™ä¸ªAIç”Ÿæˆçš„æ•°å­¦æ•™å­¦è§†é¢‘ï¼',
                    url: shareUrl
                });
            } else {
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert(`ğŸ”— åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n${shareUrl}\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™ä¸ªé“¾æ¥ä¼šæŒ‡å‘çœŸå®çš„è§†é¢‘èµ„æºã€‚`);
                }).catch(() => {
                    alert(`ğŸ”— åˆ†äº«é“¾æ¥ï¼š\n\n${shareUrl}\n\nè¯·æ‰‹åŠ¨å¤åˆ¶æ­¤é“¾æ¥è¿›è¡Œåˆ†äº«ã€‚\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™ä¸ªé“¾æ¥ä¼šæŒ‡å‘çœŸå®çš„è§†é¢‘èµ„æºã€‚`);
                });
            }
        }

        function generateSubtitles() {
            const mathContent = getMathSolutionContent();
            if (!mathContent) {
                alert('è¯·å…ˆç”Ÿæˆè§†é¢‘å†…å®¹');
                return;
            }

            // æ¨¡æ‹Ÿç”Ÿæˆå­—å¹•æ–‡ä»¶
            const subtitles = generateSRTSubtitles(mathContent);
            
            // åˆ›å»ºå¹¶ä¸‹è½½SRTæ–‡ä»¶
            const blob = new Blob([subtitles], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'math_video_subtitles.srt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('ğŸ“„ å­—å¹•æ–‡ä»¶å·²ç”Ÿæˆå¹¶ä¸‹è½½ï¼\n\nâ€¢ æ ¼å¼ï¼šSRTï¼ˆé€šç”¨å­—å¹•æ ¼å¼ï¼‰\nâ€¢ å†…å®¹ï¼šåŸºäºAIè§£é¢˜æ­¥éª¤\nâ€¢ æ—¶é—´è½´ï¼šè‡ªåŠ¨åŒæ­¥\nâ€¢ æ”¯æŒå¤šè¯­è¨€\n\næ‚¨å¯ä»¥å°†æ­¤æ–‡ä»¶ç”¨äºè§†é¢‘æ’­æ”¾å™¨ã€‚');
        }

        function generateSRTSubtitles(content) {
            const lines = content.split('\n').filter(line => line.trim());
            let srtContent = '';
            let subtitleIndex = 1;
            let currentTime = 0;

            // æ·»åŠ å¼€åœºå­—å¹•
            srtContent += `${subtitleIndex}\n`;
            srtContent += `00:00:00,000 --> 00:00:03,000\n`;
            srtContent += `æ¬¢è¿è§‚çœ‹AIæ•°å­¦æ•™å­¦è§†é¢‘\n\n`;
            subtitleIndex++;
            currentTime = 3;

            // ä¸ºæ¯ä¸ªè§£é¢˜æ­¥éª¤ç”Ÿæˆå­—å¹•
            for (let i = 0; i < Math.min(lines.length, 8); i++) {
                const line = lines[i].trim();
                if (line && !line.startsWith('**') && line.length > 10) {
                    const startTime = formatSRTTime(currentTime);
                    const endTime = formatSRTTime(currentTime + 4);
                    
                    srtContent += `${subtitleIndex}\n`;
                    srtContent += `${startTime} --> ${endTime}\n`;
                    srtContent += `${line}\n\n`;
                    
                    subtitleIndex++;
                    currentTime += 4;
                }
            }

            // æ·»åŠ ç»“å°¾å­—å¹•
            const startTime = formatSRTTime(currentTime);
            const endTime = formatSRTTime(currentTime + 3);
            srtContent += `${subtitleIndex}\n`;
            srtContent += `${startTime} --> ${endTime}\n`;
            srtContent += `è§£é¢˜å®Œæˆï¼Œæ„Ÿè°¢è§‚çœ‹ï¼\n\n`;

            return srtContent;
        }

        function formatSRTTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            const milliseconds = 0;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')},${milliseconds.toString().padStart(3, '0')}`;
        }

        // ä¸Šä¼ å›¾ç‰‡åŠŸèƒ½
        function uploadImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const textarea = document.getElementById('math-question');
                        textarea.value = `[å·²ä¸Šä¼ å›¾ç‰‡: ${file.name}]\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šï¼š\nâ€¢ ä½¿ç”¨OCRè¯†åˆ«å›¾ç‰‡ä¸­çš„æ•°å­¦å…¬å¼\nâ€¢ è‡ªåŠ¨è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼\nâ€¢ æ”¯æŒæ‰‹å†™æ•°å­¦å…¬å¼è¯†åˆ«\nâ€¢ æ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼\n\nè¯·æ‰‹åŠ¨è¾“å…¥æ•°å­¦é—®é¢˜ä»¥ç»§ç»­æ¼”ç¤ºã€‚`;
                        
                        alert(`ğŸ“¸ å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼\n\næ–‡ä»¶å: ${file.name}\nå¤§å°: ${(file.size / 1024).toFixed(2)} KB\nç±»å‹: ${file.type}\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„æ•°å­¦å…¬å¼å¹¶è½¬æ¢ä¸ºæ–‡æœ¬ã€‚`);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // è¯­éŸ³è¾“å…¥åŠŸèƒ½
        function voiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('ğŸ¤ è¯­éŸ³è¾“å…¥åŠŸèƒ½\n\næ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ã€‚\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šï¼š\nâ€¢ å®æ—¶è¯­éŸ³è½¬æ–‡å­—\nâ€¢ æ”¯æŒå¤šç§è¯­è¨€\nâ€¢ æ™ºèƒ½è¯†åˆ«æ•°å­¦æœ¯è¯­\nâ€¢ è‡ªåŠ¨æ ‡ç‚¹ç¬¦å·\n\nè¯·æ‰‹åŠ¨è¾“å…¥æ•°å­¦é—®é¢˜ä»¥ç»§ç»­æ¼”ç¤ºã€‚');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = function() {
                alert('ğŸ¤ å¼€å§‹å½•éŸ³...\n\nè¯·è¯´å‡ºæ‚¨çš„æ•°å­¦é—®é¢˜\nç‚¹å‡»"ç¡®å®š"åå¼€å§‹å½•éŸ³');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const textarea = document.getElementById('math-question');
                textarea.value = transcript;
                
                alert(`ğŸ¤ è¯­éŸ³è¯†åˆ«å®Œæˆï¼\n\nè¯†åˆ«ç»“æœ: ${transcript}\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œç³»ç»Ÿä¼šè¿›ä¸€æ­¥ä¼˜åŒ–è¯†åˆ«ç»“æœï¼Œç¡®ä¿æ•°å­¦æœ¯è¯­çš„å‡†ç¡®æ€§ã€‚`);
            };

            recognition.onerror = function(event) {
                alert(`ğŸ¤ è¯­éŸ³è¯†åˆ«é”™è¯¯: ${event.error}\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œç³»ç»Ÿä¼šæä¾›æ›´ç¨³å®šçš„è¯­éŸ³è¯†åˆ«æœåŠ¡ã€‚`);
            };

            recognition.onend = function() {
                console.log('è¯­éŸ³è¯†åˆ«ç»“æŸ');
            };

            try {
                recognition.start();
            } catch (error) {
                alert('ğŸ¤ è¯­éŸ³è¾“å…¥åŠŸèƒ½\n\nå¯åŠ¨è¯­éŸ³è¯†åˆ«æ—¶å‡ºç°é”™è¯¯ã€‚\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæä¾›ï¼š\nâ€¢ å®æ—¶è¯­éŸ³è½¬æ–‡å­—\nâ€¢ æ”¯æŒå¤šç§è¯­è¨€\nâ€¢ æ™ºèƒ½è¯†åˆ«æ•°å­¦æœ¯è¯­\nâ€¢ è‡ªåŠ¨æ ‡ç‚¹ç¬¦å·\n\nè¯·æ‰‹åŠ¨è¾“å…¥æ•°å­¦é—®é¢˜ä»¥ç»§ç»­æ¼”ç¤ºã€‚');
            }
        }

        // Update API key status on input change
        document.getElementById('api-key').addEventListener('input', updateApiKeyStatus);
    </script>
</body>
</html>